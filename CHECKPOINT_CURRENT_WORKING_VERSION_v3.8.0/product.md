# Product Specification: AWS Bedrock Partner Management System

## Overview

The AWS Bedrock Partner Management System is a serverless, AI-powered application for analyzing business opportunities, generating funding recommendations, and identifying follow-on opportunities. It leverages AWS Bedrock (Claude 3.5 Sonnet), Lambda, Athena, DynamoDB, and other AWS services to deliver real-time analytics and actionable insights through a modern web interface.

## Current Status: Production Ready with Enhanced Debug Rebuild, Sound Notifications, and Analysis Sections Fix

The system is **fully operational** with the following key improvements:

- âœ… **Enhanced Debug Rebuild**: Complete separation of SQL generation and analysis generation debug sections with clear visual distinction
- âœ… **Sound Notification System**: Visual completion notifications with user-configurable toggle and accessibility features
- âœ… **Data Consistency Fixes**: Resolved MRR extraction inconsistencies and analysis payload field mapping issues
- âœ… **Model ID Accuracy**: Fixed model ID display to show correct models for each process type
- âœ… **SQL Validation & Correction**: Automatic detection and fixing of SQL syntax errors (e.g., nested `lower()` functions)
- âœ… **Standardized Error Handling**: Consistent `'ERROR: Data not received'` messages throughout the application
- âœ… **Analysis Sections Fix**: Resolved Redis connection issues and frontend analysis section population problems
- âœ… **Redis Connection Handling**: Graceful degradation when Redis is unavailable, application continues without caching
- âœ… **Working Partner Opportunity Intelligence Page**: Fully functional HTML interface at `http://localhost:3123/`
- âœ… **Real AWS Integration**: Production backend with complete AWS service integration
- âœ… **Enhanced Debug Suite**: Real-time data flow tracing and comprehensive troubleshooting tools

## User Flows

- **Opportunity Analysis**: Users enter opportunity details (customer, region, close date, name, description) and trigger an analysis. The system generates a SQL query, retrieves historical data, and uses Bedrock to produce a comprehensive analysis.
- **Settings Management**: Users configure truncation, SQL query limits, and analysis parameters via the frontend. These settings are honored end-to-end, impacting data processing and analysis results.
- **Debug & Monitoring**: Users and admins can access real-time debug panels, view data flow, and monitor system health and performance.
- **Sound Notifications**: Users can toggle sound notifications and receive visual feedback when analysis completes.

## Data Collection & Processing

- **Input**: Opportunity details collected via a validated form.
- **Processing**: SQL query generated by Bedrock, automatically validated and corrected for syntax errors, executed via Lambda/Athena. Results are truncated or limited based on user settings. Analysis is performed by Bedrock using the latest prompt configuration.
- **Output**: Six core analysis areas (methodology, findings, risk factors, similar projects, rationale, full analysis), summary metrics (ARR, MRR, launch date, duration, confidence, top services), funding and follow-on sections.

## User Interaction

- **Modern Dashboard**: Real-time validation, progress tracking, and interactive debug panels with separated SQL and analysis sections.
- **Settings UI**: Full control over truncation, query limits, and analysis parameters.
- **Export/Print**: Professional export and print functionality for reports.
- **Sound Controls**: User-configurable sound notifications with visual feedback.
- **Debug Panels**: Comprehensive debugging interface with real-time data flow tracing.

## System Behavior

- **Error Handling**: Robust error handling with structured JSON responses, detailed logs, and standardized error messages ('ERROR: Data not received') for improved debugging and user experience.
- **SQL Validation**: Automatic detection and correction of common SQL syntax errors (nested functions, boolean expressions in functions, etc.).
- **Performance**: Lambda timeout extended to 30s; backend optimized for large datasets and real-time feedback.
- **Security**: IAM roles, encryption, secrets management, and compliance controls.
- **Monitoring**: CloudWatch, X-Ray, and custom endpoints for health and performance.
- **Sound Notifications**: Visual completion notifications with user control and accessibility features.
- **Redis Integration**: Graceful handling of Redis availability with automatic fallback to non-cached operations.

## Analysis Flow Summary

1. User submits opportunity details and settings.
2. Backend generates SQL query using Bedrock.
3. **SQL query is automatically validated and corrected for syntax errors.**
4. Lambda executes query; results are truncated/limited as per settings.
5. Bedrock analyzes data and returns structured results.
6. Frontend displays results, debug info, and allows export.
7. **Visual notification appears when analysis completes successfully.**
8. **Analysis sections are properly populated with real content from backend.**

## User-Driven Settings Impact

- All truncation, query limits, and analysis parameters are user-configurable and respected throughout the workflow, ensuring transparency and control.

## New Capabilities (2025)

- **Enhanced Debug Rebuild**: Complete separation of SQL generation and analysis generation debug sections with clear visual distinction
- **Sound Notification System**: Visual completion notifications with user-configurable toggle and accessibility features
- **Data Consistency Fixes**: Resolved MRR extraction inconsistencies and analysis payload field mapping issues
- **Model ID Accuracy**: Fixed model ID display to show correct models for each process type
- **SQL Validation & Correction**: Automatic detection and fixing of SQL syntax errors generated by AI models
- **Standardized Error Handling**: Consistent error messaging throughout the application for improved debugging
- **Analysis Sections Fix**: Resolved Redis connection issues and frontend analysis section population problems
- **Redis Connection Handling**: Graceful degradation when Redis is unavailable, application continues without caching
- **Enterprise & Multi-Environment Support**: Full AWS Organizations, Control Tower, and CI/CD pipeline implementation for seamless multi-account, multi-region deployments.
- **Disaster Recovery & Business Continuity**: Automated backup, cross-region replication, and failover with RTO/RPO objectives (RTO 15 min, RPO 1 hr, 99.9% availability).
- **Enhanced Debug Suite**: Real-time data flow tracing, advanced debug panels, and professional troubleshooting tools for both frontend and backend.
- **User-Driven Settings**: All truncation, SQL query limits, and analysis parameters are fully user-configurable and respected end-to-end.
- **Comprehensive Documentation**: Expanded user guides, workflow templates, and operational runbooks for enterprise deployment and troubleshooting.

## SQL Validation Features

- **Nested Function Detection**: Automatically detects and fixes nested `lower()` function calls
- **Boolean Expression Correction**: Fixes boolean expressions incorrectly placed within function calls
- **CASE Statement Validation**: Validates and corrects CASE statement syntax issues
- **Real-time Logging**: Logs all SQL corrections for transparency and debugging
- **Fallback Safety**: Returns original query if validation fails to prevent system disruption

## Sound Notification Features

- **Visual Notifications**: Green popup with "âœ… Analysis Complete!" message and slide-in animation
- **User Control**: Sound toggle button in header with ðŸ”Š/ðŸ”‡ icon and "Sound On"/"Sound Off" text
- **Accessibility**: Visual notifications optimized for accessibility and performance
- **Auto-Dismiss**: Notifications disappear after 3 seconds automatically
- **Error Isolation**: Notification failures can't break the analysis process
- **localStorage Integration**: User preferences persist across browser sessions

## Analysis Sections Fix Features

- **Redis Connection Handling**: Graceful degradation when Redis is unavailable
- **Frontend Section Population**: Proper population of analysis sections using backend data
- **Fallback Logic**: Automatic fallback to extraction from fullAnalysis if individual sections unavailable
- **Error Recovery**: Application continues to function without Redis caching
- **Health Monitoring**: Clear status indication for Redis availability

## Debug Architecture (2025 Update)

- **Separated Debug Sections**: Clear distinction between SQL generation (blue-themed) and analysis generation (green-themed) debug areas
- **Model ID Accuracy**: Correct model identification for each process type (Nova Pro for SQL, Claude 3.5 Sonnet for analysis)
- **Data Consistency**: Accurate MRR extraction and payload field mapping between server and frontend
- **Debug Transparency**: Only analysis prompt/model is shown for analysis steps, with full metadata
- **Nova Premier Removal**: Only Claude 3.5 Sonnet is used for all analysis and query steps
- **SQL Validation Integration**: Real-time display of SQL corrections and syntax fixes in debug panels

## References

- For technical stack and AWS integration, see `.kiro/steering/tech.md`.
- For project structure and development guidelines, see `structure.md`.
